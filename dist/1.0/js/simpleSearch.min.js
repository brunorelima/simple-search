/*!
 * Versão 1.0a
 * Última alteração 09/11/2016 15h
 * https://brunorelima.github.io/simple-search/
 */
"use strict";class SimpleSearch{static getIdentificador(){return null==this.identificador?this.identificador=1:this.identificador++,this.identificador}constructor(a){var b={method:"GET",fieldId:"id",fieldRecords:"obj.registros",fieldSizePages:"obj.propriedades.qtdPaginasTotal",paramSearch:"busca",delaySearch:200,onsuccess:function(a){return"erro"!=a.status||(this.debug&&console.error("Deu erro na resposta do servidor."),this.debug&&console.log(a),alert(a.msg),!1)}},c=$.extend({},b,a);this.paginaAtual=0,this.indexAtual=-1,this.arrayRegistros=[],this.classeLinhaSelecionada=c.tableFields?"info":"active",this.logNomeClasse="[SimpleSearch]",this.ultimoParametroPesquisado="",this.ultimaPalavraPesquisada="-1",this.isDesbloqueado=!0,this.isBlocked=!1;var d="Não foi possível inicializar o SimpleSearch. ";if(null==c.query&&null==c.queryButton)throw console.trace(),Error("Informe o nome do 'query' ou do 'queryButton'. "+this.logNomeClasse);if(void 0==c.field&&void 0==c.tableFields&&void 0==c.templateField)throw console.trace(),Error(d+"Informe o nome da 'field'. ");if(void 0==c.fieldRecords)throw console.trace(),Error(d+"Informe o 'fieldRecords'. ");if(void 0==c.url&&void 0==c.response)throw console.trace(),Error(d+"Informe a 'url' ou 'response'. ");return c.queryId&&0!=$(c.queryId).length||c.inputNames||void 0!=c.onselect?(this.query=c.query,this.url=c.url,this.method=c.method||method,this.fieldSizePages=c.fieldSizePages||fieldSizePages,this.field=c.field,this.fieldId=c.fieldId||fieldId,this.queryId=c.queryId||null,this.templateField=c.templateField,this.fieldRecords=c.fieldRecords,this.inputNames=c.inputNames,this.minLength=c.minLength||0,this.defaultValue=c.defaultValue,this.tableTitles=c.tableTitles,this.tableFields=c.tableFields,this.queryContent=c.queryContent,this.queryContentExterno=!!c.queryContent,this.queryButton=c.queryButton,this.queryForm=c.queryForm,this.fieldPages=c.fieldPages,this.paramSearch=c.paramSearch,this.delayAutoSearch=c.delayAutoSearch||-1,this.delaySearch=c.delaySearch,this.autoIniciarStarted=!1,this.templateComplement=c.templateComplement,this.tableShowSelect=c.tableShowSelect,this.tableKeepOpen=1==c.tableKeepOpen,this.debug=1==c.debug,this.whenBlurClear=1==c.whenBlurClear,this.response=c.response,this.tableLastColumn=c.tableLastColumn,this.data=c.data||function(){return""},this.onselect=c.onselect||function(){},this.onreset=c.onreset||function(){},this.onsuccess=c.onsuccess||function(a){return!0},this.classResultadoPesquisa="simpleSearchResult",this.classDestinoConteudo="containerResult",this.classItensSelecionados="containerItensSelecionados",this.classComplemento="complemento",this.containerAutoComplete="#containerPesquisa"+SimpleSearch.getIdentificador(),this.query?($(this.query).addClass("form-control"),$(this.query).width(""),$(this.query).wrap("<div id='"+this.containerAutoComplete.substring(1)+"'></div>"),$(this.query).wrap("<div class='input-group'></div>"),$(this.query).after("<span class='input-group-addon btn '>  <span class='glyphicon glyphicon-search text-primary'></span> </span> "),this.templateComplement&&$(this.containerAutoComplete).append("<div class='"+this.classComplemento+"'></div>"),$(this.containerAutoComplete).append("<div class='"+this.classDestinoConteudo+"'></div>"),this.inputNames&&$(this.containerAutoComplete).append("<div class='"+this.classItensSelecionados+"'></div>"),$(this.query).attr("autocomplete","off"),$(this.query).keydown(this._acaoPressKey.bind(this)),$(this.query).click($.proxy(function(){$(this.resultadoPesquisa+" ."+this.classeLinhaSelecionada).removeClass(this.classeLinhaSelecionada)},this))):this.queryButton&&!this.queryContent&&($(this.queryButton).keydown(this._acaoPressKey.bind(this)),$(this.queryButton).parent().parent().wrap("<div id='"+this.containerAutoComplete.substring(1)+"'></div>"),$(this.queryButton).parent().parent().after("<div class='"+this.classDestinoConteudo+"'></div>")),this.resultadoPesquisa=this.queryContent?this.queryContent:this.containerAutoComplete+" ."+this.classResultadoPesquisa,this.queryContent=this.queryContent?this.queryContent:this.containerAutoComplete+" ."+this.classDestinoConteudo,this.destinoItensSelecionados=this.containerAutoComplete+" ."+this.classItensSelecionados,this.inputNames&&this.inputNames.indexOf("[]")==-1&&(this.debug&&console.log("O paramêtro 'inputNames' não estava no formato de vetor, foi adicionado '[]' no final do nome para fazer a conversão."),this.inputNames+="[]"),this._adicionaEventos(),void this._adicionaValorPadrao()):(console.trace(),void console.error("Propriedade 'queryId' não encontrada. Confira a passagem deste parametro. "+this.logNomeClasse))}_adicionaValorPadrao(){if(this.defaultValue)if(this.defaultValue[0]&&!Array.isArray(this.defaultValue[0])&&this.defaultValue[1]&&!Array.isArray(this.defaultValue[1])){var a=this.defaultValue[2]?this.defaultValue[2]:"";this.select(this.defaultValue[0],this.defaultValue[1],a)}else Array.isArray(this.defaultValue)&&this.defaultValue.forEach(function(a){if(a[0]&&a[1]){var b=a[2]?a[2]:"";this.select(a[0],a[1],b)}},this)}_adicionaEventos(){this.query?($(document).click($.proxy(function(a){""!=$(this.queryContent).html()&&($(a.target).hasClass("clk-btn-next")||$(a.target).hasClass("clk-btn-prev")||0!=$(a.target).closest(this.containerAutoComplete).length||1!=this.tableKeepOpen&&this._limparConteudo())},this)),$(this.query).next().click($.proxy(function(){this._acaoBotaoPesquisarOuDesbloquear()},this)),$(this.query).dblclick($.proxy(function(){this._desbloquear(!0),this._setComplemento("")},this)),$(this.query).next().addClass("btn")):this.queryButton&&$(this.queryButton).click($.proxy(function(){this.isDesbloqueado&&this._pesquisar(1)},this)),this.queryForm&&($(this.queryForm+" .search-on-enter").attr("autocomplete","off"),$(this.queryForm+" .search-on-enter").keydown(this._acaoPressKey.bind(this)))}_removeEventos(){this.query?($(this.query).next().unbind("click"),$(this.query).unbind("dblclick"),$(this.query).next().removeClass("btn")):this.queryButton&&$(this.queryButton).unbind("click")}_desbloquear(a){this.isDesbloqueado=!0,$(this.query).removeAttr("readonly"),$(this.query).next().children().removeClass("glyphicon-remove").addClass("glyphicon-search"),1==a&&$(this.query).select(),this.queryId&&$(this.queryId).val("")}_acaoBotaoPesquisarOuDesbloquear(){this.isDesbloqueado?this._pesquisar(1):(this._desbloquear(!0),this._setComplemento(""))}_pesquisar(a){if(this.idTimeoutAutoSearch&&(clearTimeout(this.idTimeoutAutoSearch),this.autoIniciarStarted=!1),this.idTimeoutSearch)return void(this.debug&&console.log("Pesquisa cancelada. O intervalo da última pesquisa foi muito pequeno."));if(this.idTimeoutSearch=window.setTimeout($.proxy(function(){clearTimeout(this.idTimeoutSearch),this.idTimeoutSearch=null},this),this.delaySearch),this.query&&"readonly"==$(this.query).attr("readonly")||0==this.isDesbloqueado)return void(this.autoIniciarStarted=!1);if(this.query&&$(this.query).val().length<this.minLength){this.debug&&console.log("Para pesquisar precisa digitar pelo menos "+this.minLength+" caracteres.");var b="<p> <small> <span class='glyphicon glyphicon-alert text-warning'></span> ";return b+="<strong> Para pesquisar precisa digitar pelo menos "+this.minLength+" caracteres. </strong> </small> </p>",$(this.queryContent).html(b),void(this.autoIniciarStarted=!1)}a=a||1;var c="pagina="+a;c+=this.query?"&"+this.paramSearch+"="+$(this.query).val():"",c+=this.queryForm?"&"+$(this.queryForm).serialize():"";var d=this.data&&"function"==typeof this.data?this.data():this.data;return c+=d&&""!=d?"&"+jQuery.param(d):"",this.ultimoParametroPesquisado==c&&""!=$(this.queryContent).html()?(this.debug&&console.log("Repetiu a busca: "+c),void(this.autoIniciarStarted=!1)):(this.ultimaPalavraPesquisada=$(this.query).val(),this.ultimoParametroPesquisado=c,this.paginaAtual=void 0!=a?a:this.paginaAtual,void(this.response?this._trataRepostaServidor(this.response(a,$(this.query).val())):(this.ajax&&this.ajax.abort(),this.ajax=$.ajax({url:this.url,data:c,dataType:"json",method:this.method,context:this,success:function(a){this._trataRepostaServidor(a)},error:function(a){0!=a.readyState&&console.error(a);var b="<p> <small> <span class='glyphicon glyphicon-exclamation-sign text-danger'></span> ";b+="<strong>Erro na consulta do simpleSearch </strong> </small> </p>",$(this.queryContent).html(b)},beforeSend:function(){var a=" <div class='progress' role='progressbar' style='height: 10px;'> <div class='progress-bar progress-bar-striped active' role='progressbar' aria-valuenow='100' aria-valuemin='0' aria-valuemax='100' style='width: 100%' >";a+="<span class='sr-only glyphicon glyphicon-hourglass text-primary'><small><strong>Carregando... </strong></small></span>  </div> </div>",$(this.queryContent).html(a)},complete:function(){this.autoIniciarStarted=!1;var a=$(this.queryContent).html();a.indexOf("progressbar")>0&&$(this.queryContent).html("")}}))))}_trataRepostaServidor(response){var continuarExecutando=this.onsuccess(response);if(continuarExecutando){try{var obj=eval("response."+this.fieldRecords)}catch(a){throw this.debug&&console.log(a),this.debug&&console.log(response),Error("Parâmetro configurado para 'fieldRecords' incorreto. Confira a resposta do servidor.")}if(void 0==obj)return void console.error("Objeto de registros indefinido. Confira se o argumento de 'fieldRecords' está correto. "+this.logNomeClasse);if(this.arrayRegistros=this.fieldRecords&&obj?obj:response.obj,this.arrayRegistros[0]&&void 0==this.arrayRegistros[0][this.field]&&console.error("Valor da 'field' do item está indefinido, confira se o parametro passado está correto. "+this.logNomeClasse),this.arrayRegistros[0]&&void 0==this.arrayRegistros[0][this.fieldId]&&console.error("Valor da 'fieldId' do item está indefinido, confira se o parametro passado está correto. "+this.logNomeClasse),null!=this.arrayRegistros&&this.arrayRegistros.length>0){var htmlSaida="";1==this.tableKeepOpen&&(htmlSaida+="<div> ",htmlSaida+="  <div class='glyphicon glyphicon-remove text-danger pull-right acao-fechar' aria-hidden='true' title='Fechar tabela' style='cursor: pointer;'> </div> "),this.tableFields?(htmlSaida+="<table class='table table-bordered table-striped table-hover "+this.classResultadoPesquisa+"' style='margin-bottom: 0;'>",this.tableTitles&&(htmlSaida+="<tr>",this.tableShowSelect&&(htmlSaida+="<td width='42px'> </td>"),this.tableTitles.forEach(function(a,b){htmlSaida+="<th> "+a+" </th>"}),this.tableLastColumn&&(htmlSaida+="<th></th>"),htmlSaida+="</tr>"),this.arrayRegistros.forEach(function(a,b){htmlSaida+="<tr class='linhaSs' style='cursor:pointer'>",this.tableShowSelect&&(htmlSaida+="<td class='text-center'> <button type='button' class='btn btn-default btn-xs'> <span class='glyphicon glyphicon-ok'></span> </button> </td>"),this.tableFields.forEach(function(b,c){htmlSaida+="<td> "+a[b]+" </td>"},this),this.tableLastColumn&&(htmlSaida+="function"===this.tableLastColumn||this.tableLastColumn instanceof Function?"<td> "+this._atualizaValoresTemplate(a,this.tableLastColumn())+" </td>":"<td> "+this._atualizaValoresTemplate(a,this.tableLastColumn)+" </td>"),htmlSaida+="</tr>"},this),htmlSaida+="</table>"):(htmlSaida+="<ul class='list-group "+this.classResultadoPesquisa+"' style='margin-bottom: 0;'>",this.arrayRegistros.forEach(function(a,b){var c=this.inputNames&&0!=$(this.destinoItensSelecionados+" input[value='"+a[this.fieldId]+"']").length?"disabled":"";htmlSaida+="<li class='list-group-item linhaSs "+c+"' style='cursor: pointer;'>",htmlSaida+=this.templateField?this._atualizaValoresTemplate(a,this.templateField):a[this.field],htmlSaida+=" </li>"},this),htmlSaida+="</ul>");var qtdPaginasTotal=eval("response."+this.fieldSizePages)||-1,complementoBotaoAnterior=1==this.paginaAtual?"disabled":"",complementoBotaoProximo=this.paginaAtual==qtdPaginasTotal?"disabled":"";if(qtdPaginasTotal&&qtdPaginasTotal>1){this.paginaAtual=this.paginaAtual>qtdPaginasTotal+1?qtdPaginasTotal+1:this.paginaAtual;var dadosPaginacao=null;try{dadosPaginacao=this.fieldPages?eval("response."+this.fieldPages):null}catch(a){console.warn("Erro ao usar o parâmetro 'fieldPages': "+this.fieldPages)}dadosPaginacao?(htmlSaida+="<div class='btn-group' role='group'> <div class='text-center'> ",htmlSaida+=" <ul class='pagination'> ",dadosPaginacao&&dadosPaginacao.forEach(function(a,b){var c="  <li class='#active#' data-pagina='#pagina#' ><a href='javascript:void(0)'>#legenda#</a></li> ";htmlSaida+=this._atualizaValoresTemplate(a,c)},this),htmlSaida+=" </ul>  ",htmlSaida+="</div></div>"):(htmlSaida+="<div class='btn-group btn-group-justified' role='group'>",htmlSaida+="<div class='btn-group' role='group'> <button type='button' class='btn btn-primary clk-btn-prev' "+complementoBotaoAnterior+"> Anterior </button>  </div>",htmlSaida+="<div class='btn-group' role='group'> <button type='button' class='btn btn-primary clk-btn-next' "+complementoBotaoProximo+"> Próxima </button>  </div>",htmlSaida+="</div>")}this.queryContentExterno&&(htmlSaida+="</div> "),$(this.queryContent).html(htmlSaida),1==this.tableKeepOpen&&($(this.queryContent).undelegate(".acao-fechar","click"),$(this.queryContent).delegate(".acao-fechar","click",this._limparConteudo.bind(this))),$(this.queryContent).undelegate(".linhaSs","click"),$(this.queryContent).delegate(".linhaSs","click",this._acaoClickMouse.bind(this)),$(this.resultadoPesquisa).undelegate(".linhaSs","mouseover"),$(this.resultadoPesquisa).delegate(".linhaSs","mouseover",this._acaoMouseOver.bind(this)),$(this.queryContent).undelegate(".clk-btn-prev","click"),$(this.queryContent).delegate(".clk-btn-prev","click",this._voltaPagina.bind(this)),$(this.queryContent).undelegate(".clk-btn-next","click"),$(this.queryContent).delegate(".clk-btn-next","click",this._proximaPagina.bind(this)),$(this.queryContent).undelegate(".pagination li","click"),$(this.queryContent).delegate(".pagination li","click",$.proxy(function(a){var b=$(this.queryContent+" .pagination li").index($(a.currentTarget));if(b>=0){var c=$(this.queryContent+" .pagination li")[b],d=$(c).data("pagina");this._pesquisar(d)}},this))}else{var msg="<small><p> <span class='glyphicon glyphicon-info-sign text-primary'></span> ";msg+="<strong>Nenhum resultado encontrado para o termo informado. </strong></p></small>",$(this.queryContent).html(msg),this.paginaAtual=this.paginaAtual-1}$(this.query).focus()}}_atualizaValoresTemplate(a,b){return $.each(a,function(a,c){var d="#"+a+"#",e=new RegExp(d,"ig");b=b.replace(e,null==c?"":c)}),b}_selecionaLinha(a){if(a){this._limparConteudo();var b=this.templateComplement?this._atualizaValoresTemplate(a,this.templateComplement):"";this.select(a[this.fieldId],a[this.field],b,!0),this.onselect(a)}}_setComplemento(a){if(this.templateComplement){var b=a?"<div class='form-control' readonly style='height: auto; font-size: 0.85em;'> "+a+" </div>":"";$(this.containerAutoComplete+" ."+this.classComplemento).html(b)}}_geraComplementoElemento(a){return this.inputNames&&a?"<div class='form-control' readonly style='height: auto; font-size: 0.85em;'> "+a+" </div>":""}_acaoClickMouse(a){this.indexAtual=$(this.resultadoPesquisa+" .linhaSs").index($(a.currentTarget)),this._selecionaLinha(this.arrayRegistros[this.indexAtual])}_acaoClickMouseRemoverItem(a){$(a.currentTarget).parent().parent().remove()}_acaoMouseOver(a){$(this.resultadoPesquisa+" ."+this.classeLinhaSelecionada).removeClass(this.classeLinhaSelecionada),$(a.currentTarget).addClass(this.classeLinhaSelecionada)}_acaoPressKey(a){if(!$(this.query).attr("readonly"))switch(a.keyCode){case 13:this.indexAtual=$(this.resultadoPesquisa+" .linhaSs").index($(this.resultadoPesquisa+" ."+this.classeLinhaSelecionada)),this.indexAtual>=0?(this._selecionaLinha(this.arrayRegistros[this.indexAtual]),a.preventDefault()):(this._pesquisar(1),a.preventDefault());break;case 27:this._limparConteudo();break;case 9:1!=this.tableKeepOpen&&this._limparConteudo();break;case 37:this._voltaPagina();break;case 39:this._proximaPagina();break;case 40:this.indexAtual=$(this.resultadoPesquisa+" .linhaSs").index($(this.resultadoPesquisa+" ."+this.classeLinhaSelecionada)),this.indexAtual++,$(this.resultadoPesquisa+" ."+this.classeLinhaSelecionada).removeClass(this.classeLinhaSelecionada),$(this.resultadoPesquisa+" .linhaSs:eq("+this.indexAtual+")").addClass(this.classeLinhaSelecionada),a.preventDefault();break;case 38:this.indexAtual=$(this.resultadoPesquisa+" .linhaSs").index($(this.resultadoPesquisa+" ."+this.classeLinhaSelecionada)),this.indexAtual--,$(this.resultadoPesquisa+" ."+this.classeLinhaSelecionada).removeClass(this.classeLinhaSelecionada),$(this.resultadoPesquisa+" .linhaSs:eq("+this.indexAtual+")").addClass(this.classeLinhaSelecionada),a.preventDefault();break;case 33:this._voltaPagina(),a.preventDefault();break;case 34:this._proximaPagina(),a.preventDefault();break;case 16:break;case 17:break;case 18:break;case 20:break;case 32:break;case 36:break;case 35:break;case 144:break;default:$(this.resultadoPesquisa+" ."+this.classeLinhaSelecionada).removeClass(this.classeLinhaSelecionada),this.delayAutoSearch!=-1&&(this.idTimeoutAutoSearch&&(clearTimeout(this.idTimeoutAutoSearch),this.autoIniciarStarted=!1),0==this.autoIniciarStarted&&(this.autoIniciarStarted=!0,this.idTimeoutAutoSearch=window.setTimeout($.proxy(function(){this._pesquisar(1)},this),this.delayAutoSearch)))}}_proximaPagina(){return("-1"!=this.ultimaPalavraPesquisada&&this.ultimaPalavraPesquisada!=$(this.query).val()||""==this.ultimaPalavraPesquisada&&""==$(this.query).val()&&""==$(this.queryContent).html())&&(this.paginaAtual=0),this.ultimaPalavraPesquisada==$(this.query).val()&&""!=$(this.queryContent).html()&&(0==$(".clk-btn-next").length||$(".clk-btn-next[disabled]").length>0)&&(0==$(".pagination").length||$(".pagination li:last-child.active").length>0)?void(this.debug&&console.log("Pesquisa cancelada por usar mesmo termo pesquisado.")):void this._pesquisar(this.paginaAtual+1)}_voltaPagina(){return this.ultimaPalavraPesquisada==$(this.query).val()&&(0==$(".clk-btn-prev").length||$(".clk-btn-prev[disabled]").length>0)&&(0==$(".pagination").length||$(".pagination li:first-child.active").length>0)?void(this.debug&&console.log("Pesquisa cancelada por usar mesmo termo pesquisado.")):void this._pesquisar(this.paginaAtual>1?this.paginaAtual-1:1)}_limparConteudo(){$(this.queryContent).html(""),this.ultimoParametroPesquisado="",this.ultimaPalavraPesquisada="-1",this.paginaAtual=0,this.whenBlurClear&&$(this.query).val("")}reset(){this.isBlocked||($(this.query).val(""),$(this.destinoItensSelecionados).html(""),this._setComplemento(""),this._limparConteudo(),this._desbloquear(!1)),this._adicionaValorPadrao(),this.onreset()}select(a,b,c,d){if(this.inputNames){if(this.inputNames&&0==$(this.destinoItensSelecionados+" input[value='"+a+"']").length){var e=this._geraComplementoElemento(c),f="<div> <div class='input-group input-group-sm'> ";f+="<span class='input-group-btn itemSs'> <button class='btn btn-danger' type='button'>X</button> </span> ",f+="<input class='form-control' name='_"+this.inputNames+"' value='"+b+"' readonly /> <input type='hidden' name='"+this.inputNames+"' value='"+a+"'>",f+=" </div> "+e+"  </div>",$(this.destinoItensSelecionados).append(f),1==d&&$(this.query).focus(),$(this.destinoItensSelecionados).undelegate(".itemSs","click"),$(this.destinoItensSelecionados).delegate(".itemSs","click",this._acaoClickMouseRemoverItem.bind(this))}}else $(this.query).val(b),$(this.query).attr("readonly","readonly"),$(this.query).next().children().removeClass("glyphicon-search").addClass("glyphicon-remove"),this.queryId&&$(this.queryId).val(a?a:""),this.query&&(this.isDesbloqueado=!1),c&&this._setComplemento(c)}disabled(){this.isBlocked=!0,this.query?($(this.query).attr("readonly","readonly"),$(this.query).next().children().removeClass("glyphicon-search").removeClass("glyphicon-remove").addClass("glyphicon-lock")):this.queryButton&&$(this.queryButton).attr("disabled","disabled"),this._removeEventos()}enabled(){this.isBlocked=!1,this._adicionaEventos(),this.query?this.isDesbloqueado?($(this.query).removeAttr("readonly"),$(this.query).next().children().removeClass("glyphicon-lock").addClass("glyphicon-search").removeClass("glyphicon-remove")):$(this.query).next().children().removeClass("glyphicon-lock").removeClass("glyphicon-search").addClass("glyphicon-remove"):this.queryButton&&$(this.queryButton).removeAttr("disabled")}focus(){$(this.query).focus()}}